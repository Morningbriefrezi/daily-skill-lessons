import os
import asyncio
from datetime import datetime
from telegram import Bot
from openai import OpenAI
import pytz
import httpx
import random

# ENV
TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')
CHAT_ID = os.getenv('TELEGRAM_CHAT_ID')

TBILISI_TZ = pytz.timezone('Asia/Tbilisi')

# РћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђ
# BROAD SKILL DOMAINS (EXPANDED MASSIVELY)
# РћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђ

SKILL_DOMAINS = [
    "рЃАрЃбрЃарЃљрЃбрЃћрЃњрЃўрЃБрЃџрЃў рЃљрЃќрЃарЃЮрЃЋрЃюрЃћрЃЉрЃљ",
    "рЃбрЃљрЃЦрЃбрЃўрЃЎрЃБрЃарЃў рЃњрЃљрЃЊрЃљрЃгрЃДрЃЋрЃћрЃбрЃўрЃџрЃћрЃЉрЃћрЃЉрЃў",
    "рЃЏрЃЮрЃџрЃљрЃърЃљрЃарЃљрЃЎрЃћрЃЉрЃўрЃА рЃцрЃАрЃўрЃЦрЃЮрЃџрЃЮрЃњрЃўрЃљ",
    "рЃцрЃљрЃАрЃўрЃА рЃЊрЃљрЃфрЃЋрЃўрЃА рЃбрЃћрЃЦрЃюрЃўрЃЎрЃљ",
    "рЃЎрЃЮрЃюрЃцрЃџрЃўрЃЦрЃбрЃўрЃА рЃЏрЃљрЃарЃЌрЃЋрЃљ",
    "рЃърЃћрЃарЃАрЃБрЃљрЃќрЃўрЃљ рЃЊрЃљ рЃњрЃљрЃЋрЃџрЃћрЃюрЃљ",
    "рЃЎрЃЮрЃњрЃюрЃўрЃбрЃБрЃарЃў рЃЉрЃљрЃўрЃљрЃАрЃћрЃЉрЃў",
    "рЃАрЃўрЃАрЃбрЃћрЃЏрЃБрЃарЃў рЃЊрЃўрЃќрЃљрЃўрЃюрЃў",
    "рЃърЃарЃЮрЃфрЃћрЃАрЃћрЃЉрЃўрЃА рЃЮрЃърЃбрЃўрЃЏрЃўрЃќрЃљрЃфрЃўрЃљ",
    "рЃарЃћрЃърЃБрЃбрЃљрЃфрЃўрЃўрЃА рЃЏрЃљрЃарЃЌрЃЋрЃљ",
    "рЃЊрЃарЃЮрЃўрЃА рЃћрЃюрЃћрЃарЃњрЃћрЃбрЃўрЃЎрЃБрЃџрЃў рЃЏрЃљрЃарЃЌрЃЋрЃљ",
    "рЃцрЃўрЃюрЃљрЃюрЃАрЃБрЃарЃў рЃљрЃќрЃарЃЮрЃЋрЃюрЃћрЃЉрЃљ",
    "рЃарЃўрЃАрЃЎрЃўрЃА рЃерЃћрЃцрЃљрЃАрЃћрЃЉрЃљ",
    "рЃерЃљрЃюрЃАрЃћрЃЉрЃўрЃА рЃљрЃюрЃљрЃџрЃўрЃќрЃў",
    "рЃЎрЃљрЃърЃўрЃбрЃљрЃџрЃўрЃА рЃЊрЃљрЃњрЃарЃЮрЃЋрЃћрЃЉрЃўрЃА рЃърЃарЃўрЃюрЃфрЃўрЃърЃћрЃЉрЃў",
    "рЃњрЃљрЃДрЃўрЃЊрЃЋрЃћрЃЉрЃўрЃА рЃЊрЃљрЃ«рЃБрЃарЃЋрЃўрЃА рЃбрЃћрЃЦрЃюрЃўрЃЎрЃљ",
    "рЃЉрЃљрЃќрЃарЃўрЃА рЃърЃЮрЃќрЃўрЃфрЃўрЃЮрЃюрЃўрЃарЃћрЃЉрЃљ",
    "рЃърЃўрЃарЃљрЃЊрЃў рЃЉрЃарЃћрЃюрЃЊрЃўрЃюрЃњрЃў",
    "рЃАрЃгрЃарЃљрЃцрЃў рЃАрЃгрЃљрЃЋрЃџрЃћрЃЉрЃўрЃА рЃЏрЃћрЃЌрЃЮрЃЊрЃћрЃЉрЃў",
    "рЃцрЃЮрЃЎрЃБрЃАрЃўрЃА рЃњрЃљрЃФрЃџрЃўрЃћрЃарЃћрЃЉрЃљ",
    "рЃЏрЃўрЃЎрЃарЃЮ-рЃЕрЃЋрЃћрЃЋрЃћрЃЉрЃўрЃА рЃўрЃюрЃЪрЃўрЃюрЃћрЃарЃўрЃљ",
    "рЃерЃћрЃЊрЃћрЃњрЃќрЃћ рЃЮрЃарЃўрЃћрЃюрЃбрЃўрЃарЃћрЃЉрЃБрЃџрЃў рЃЎрЃЮрЃЏрЃБрЃюрЃўрЃЎрЃљрЃфрЃўрЃљ",
    "рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃќрЃћ рЃЊрЃљрЃцрЃБрЃФрЃюрЃћрЃЉрЃБрЃџрЃў рЃљрЃќрЃарЃЮрЃЋрЃюрЃћрЃЉрЃљ",
    "рЃАрЃљрЃБрЃЉрЃарЃўрЃА рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃўрЃарЃћрЃЉрЃљ",
    "рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃўрЃА рЃЊрЃћрЃЎрЃЮрЃЏрЃърЃЮрЃќрЃўрЃфрЃўрЃљ",
    "рЃерЃћрЃАрЃљрЃФрЃџрЃћрЃЉрЃџрЃЮрЃЉрЃўрЃА рЃўрЃЊрЃћрЃюрЃбрЃўрЃцрЃўрЃЎрЃљрЃфрЃўрЃљ",
    "рЃАрЃЮрЃфрЃўрЃљрЃџрЃБрЃарЃў рЃЊрЃўрЃюрЃљрЃЏрЃўрЃЎрЃљ",
    "рЃњрЃљрЃЋрЃџрЃћрЃюрЃўрЃА рЃљрЃарЃЦрЃўрЃбрЃћрЃЦрЃбрЃБрЃарЃљ",
    "рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃБрЃџрЃЮрЃЉрЃўрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃћрЃЉрЃў",
    "рЃЏрЃћрЃюрЃбрЃљрЃџрЃБрЃарЃў рЃЏрЃЮрЃЊрЃћрЃџрЃћрЃЉрЃў",
    "рЃАрЃбрЃарЃћрЃАрЃўрЃА рЃЎрЃЮрЃюрЃбрЃарЃЮрЃџрЃў",
    "рЃАрЃљрЃЋрЃљрЃГрЃарЃЮ рЃљрЃќрЃарЃЮрЃЋрЃюрЃћрЃЉрЃљ",
    "рЃцрЃљрЃАрЃўрЃА рЃљрЃдрЃЦрЃЏрЃўрЃА рЃЏрЃћрЃЦрЃљрЃюрЃўрЃќрЃЏрЃў",
    "рЃАрЃўрЃАрЃбрЃћрЃЏрЃБрЃарЃў рЃЊрЃўрЃАрЃфрЃўрЃърЃџрЃўрЃюрЃљ",
    "рЃЏрЃфрЃўрЃарЃћ рЃБрЃърЃўрЃарЃљрЃбрЃћрЃАрЃЮрЃЉрЃћрЃЉрЃўрЃА рЃЊрЃљрЃњрЃарЃЮрЃЋрЃћрЃЉрЃљ"
]

def get_daily_domain():
    today = datetime.now(TBILISI_TZ)
    index = today.timetuple().tm_yday % len(SKILL_DOMAINS)
    return SKILL_DOMAINS[index]

# РћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђ
# GENERATION
# РћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђ

def generate_daily_lesson() -> str:
    today = datetime.now(TBILISI_TZ)
    domain = get_daily_domain()

    # Daily randomness seed
    daily_seed = today.strftime("%Y-%m-%d")

    prompt = f"""
рЃЊрЃдрЃћрЃА рЃЌрЃљрЃарЃўрЃдрЃўрЃљ: {daily_seed}
рЃЊрЃдрЃўрЃА рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў рЃАрЃцрЃћрЃарЃЮ: {domain}

рЃерЃћрЃЦрЃЏрЃћрЃюрЃў рЃћрЃарЃЌрЃў рЃЊрЃдрЃўрЃБрЃарЃў рЃЏрЃўрЃЎрЃарЃЮ-рЃњрЃљрЃЎрЃЋрЃћрЃЌрЃўрЃџрЃў рЃЦрЃљрЃарЃЌрЃБрЃџ рЃћрЃюрЃљрЃќрЃћ.

р▓Џр▓Ўр▓љр▓фр▓ар▓ў р▓гр▓ћр▓Ар▓ћр▓Љр▓ў:
- рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃЦрЃљрЃарЃЌрЃБрЃџрЃў рЃћрЃюрЃљ
- 180-250 рЃАрЃўрЃбрЃДрЃЋрЃљ
- рЃћрЃЏрЃЮрЃ»рЃў рЃљрЃа рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃЮ
- рЃљрЃа рЃЊрЃљрЃгрЃћрЃарЃЮ рЃЏрЃЮрЃбрЃўрЃЋрЃљрЃфрЃўрЃБрЃарЃў рЃбрЃћрЃЦрЃАрЃбрЃў
- рЃљрЃа рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃЮ рЃќрЃЮрЃњрЃљрЃЊрЃў рЃцрЃарЃљрЃќрЃћрЃЉрЃў
- рЃљрЃа рЃњрЃљрЃўрЃЏрЃћрЃЮрЃарЃЮ рЃгрЃўрЃюрЃљ рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃБрЃџрЃў рЃерЃљрЃЉрЃџрЃЮрЃюрЃћрЃЉрЃў
- рЃљрЃа рЃерЃћрЃЦрЃЏрЃюрЃљ рЃћрЃарЃЌрЃў рЃЊрЃљ рЃўрЃњрЃўрЃЋрЃћ рЃбрЃўрЃърЃўрЃА рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў рЃДрЃЮрЃЋрЃћрЃџрЃЊрЃдрЃћ

р▓Ар▓бр▓ар▓Бр▓Цр▓бр▓Бр▓ар▓љ:

1) рЃЊрЃдрЃўрЃА рЃБрЃюрЃљрЃарЃў (рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў рЃЊрЃљ рЃАрЃърЃћрЃфрЃўрЃцрЃўрЃЎрЃБрЃарЃў)
2) рЃФрЃўрЃарЃўрЃЌрЃљрЃЊрЃў рЃърЃарЃўрЃюрЃфрЃўрЃърЃў (рЃЏрЃћрЃЦрЃљрЃюрЃўрЃќрЃЏрЃў, рЃљрЃарЃљ рЃцрЃўрЃџрЃЮрЃАрЃЮрЃцрЃўрЃљ)
3) рЃарЃћрЃљрЃџрЃБрЃарЃў рЃАрЃфрЃћрЃюрЃљрЃарЃў (рЃЉрЃўрЃќрЃюрЃћрЃАрЃў, рЃЏрЃЮрЃџрЃљрЃърЃљрЃарЃљрЃЎрЃћрЃЉрЃљ, рЃърЃўрЃарЃљрЃЊрЃў рЃЏрЃљрЃарЃЌрЃЋрЃљ рЃљрЃю рЃцрЃўрЃюрЃљрЃюрЃАрЃћрЃЉрЃў)
4) рЃЏрЃўрЃЎрЃарЃЮ-рЃАрЃљрЃЋрЃљрЃарЃ»рЃўрЃерЃЮ (5 рЃгрЃБрЃЌрЃўрЃљрЃюрЃў, рЃърЃарЃљрЃЦрЃбрЃўрЃЎрЃБрЃџрЃў)
5) рЃбрЃўрЃърЃўрЃБрЃарЃў рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ
6) рЃћрЃарЃЌрЃў рЃќрЃБрЃАрЃбрЃў рЃЦрЃЏрЃћрЃЊрЃћрЃЉрЃљ рЃЊрЃдрЃћрЃА

рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћ рЃњрЃљрЃюрЃАрЃ«рЃЋрЃљрЃЋрЃћрЃЉрЃБрЃџрЃў рЃЏрЃћрЃюрЃбрЃљрЃџрЃБрЃарЃў рЃЏрЃЮрЃЊрЃћрЃџрЃў.
рЃЊрЃдрЃћрЃА рЃљрЃа рЃњрЃљрЃўрЃЏрЃћрЃЮрЃарЃЮ рЃЕрЃЋрЃћрЃБрЃџрЃћрЃЉрЃарЃўрЃЋрЃў рЃЎрЃЮрЃЏрЃБрЃюрЃўрЃЎрЃљрЃфрЃўрЃўрЃА рЃљрЃю рЃЊрЃарЃЮрЃўрЃА рЃЏрЃљрЃарЃЌрЃЋрЃўрЃА рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃў.
рЃЏрЃўрЃљрЃгрЃЮрЃЊрЃћ рЃќрЃБрЃАрЃбрЃљрЃЊ рЃћрЃарЃЌрЃў рЃњрЃљрЃЎрЃЋрЃћрЃЌрЃўрЃџрЃў.
"""

    try:
        http_client = httpx.Client()
        client = OpenAI(
            api_key=OPENAI_API_KEY,
            http_client=http_client
        )

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "system",
                    "content": "рЃерЃћрЃю рЃЦрЃЏрЃюрЃў рЃЏрЃљрЃдрЃљрЃџрЃў рЃЊрЃЮрЃюрЃўрЃА, рЃърЃарЃљрЃЦрЃбрЃўрЃЎрЃБрЃџ рЃЊрЃљ рЃАрЃбрЃарЃљрЃбрЃћрЃњрЃўрЃБрЃџ рЃБрЃюрЃљрЃарЃћрЃЉрЃА. рЃерЃћрЃюрЃў рЃЏрЃўрЃќрЃљрЃюрЃўрЃљ рЃДрЃЮрЃЋрЃћрЃџрЃЊрЃдрЃўрЃБрЃарЃљрЃЊ рЃњрЃљрЃюрЃАрЃ«рЃЋрЃљрЃЋрЃћрЃЉрЃБрЃџрЃў, рЃдрЃарЃЏрЃљ рЃЊрЃљ рЃљрЃарЃљрЃњрЃћрЃюрЃћрЃарЃўрЃЎрЃБрЃџрЃў рЃњрЃљрЃЎрЃЋрЃћрЃЌрЃўрЃџрЃћрЃЉрЃўрЃА рЃерЃћрЃЦрЃЏрЃюрЃљ."
                },
                {
                    "role": "user",
                    "content": prompt
                }
            ],
            temperature=0.95,
            max_tokens=900
        )

        http_client.close()
        return response.choices[0].message.content

    except Exception as e:
        return f"рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ: {str(e)}"

# РћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђ
# TELEGRAM SEND
# РћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђРћђ

async def send_lesson():
    lesson = generate_daily_lesson()
    bot = Bot(token=TELEGRAM_BOT_TOKEN)

    await bot.send_message(
        chat_id=CHAT_ID,
        text=lesson,
        parse_mode=None
    )

def main():
    if not TELEGRAM_BOT_TOKEN or not OPENAI_API_KEY or not CHAT_ID:
        print("Missing ENV variables")
        return

    print("­ЪЊџ Daily Skill Bot Running")
    asyncio.run(send_lesson())

if __name__ == '__main__':
    main()
